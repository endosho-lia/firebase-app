<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyACBuhohMmUJc_aQScQGqeLMN8mmsxRFmo",
  authDomain: "liagroup-a1ab1.firebaseapp.com",
  projectId: "liagroup-a1ab1",
  storageBucket: "liagroup-a1ab1.appspot.com",
  messagingSenderId: "361842389207",
  appId: "1:361842389207:web:1a7b92ef9d85b2726a4092"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ★既にログイン済みならmenuへ
onAuthStateChanged(auth, user=>{
  if(user){
    location.replace("menu.html");
  }
});

window.login = async function() {

  const email = email.value;
  const password = password.value;

  try {
    const userCredential =
      await signInWithEmailAndPassword(auth, email, password);

    const user = userCredential.user;

    const userDoc = await getDoc(doc(db, "users", user.uid));

    if (!userDoc.exists()) {
      await setDoc(doc(db, "users", user.uid), {
        role: "user",
        name: email.split("@")[0],
        createdAt: serverTimestamp()
      });
    }

    location.replace("menu.html");

  } catch (error) {
    alert("ログイン失敗：" + error.message);
  }
}
</script>