<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æ—¥å ±ç®¡ç†</title>
<link rel="stylesheet" href="menu.css">

<style>
body{font-family:sans-serif;margin:0;background:#f5f5f5}
.container{padding:20px;max-width:900px;margin:auto}

input,select,textarea{
 width:100%;padding:8px;margin:4px 0;border-radius:6px;border:1px solid #ccc
}

button{
 padding:10px 16px;background:#4285f4;color:#fff;border:none;border-radius:8px;cursor:pointer
}

table{width:100%;border-collapse:collapse;background:#fff;margin-top:10px}
td,th{border:1px solid #ddd;padding:6px;text-align:center}

.addBtn{margin:10px 0}
</style>
</head>

<body>
<div id="menu"></div>

<div class="container">

<h2>æ—¥å ±å…¥åŠ›</h2>

<label>åº—èˆ—</label>
<input id="store" value="å¤©ç«¥">

<label>æ‹…å½“è€…</label>
<input id="staff">

<label>æ¡ˆä»¶ç•ªå·</label>
<input id="caseNumber" readonly>

<h3>è²·å–å†…å®¹</h3>

<button class="addBtn" onclick="addRow()">ï¼‹è¿½åŠ </button>

<table id="buyTable">
<thead>
<tr>
<th>å“ç›®</th>
<th>å“ç‰©å</th>
<th>è²·å–é‡‘é¡</th>
<th>è²©å£²è¦‹è¾¼</th>
<th>ãƒ¡ãƒ¢</th>
<th></th>
</tr>
</thead>
<tbody></tbody>
</table>

<br>
<button onclick="saveReport()">æ—¥å ±ä¿å­˜</button>

</div>

<script type="module" src="menu.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import {
 getFirestore,collection,addDoc,getDocs,query,where,serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

/* Firebase */
const firebaseConfig={
 apiKey:"AIzaSyACBuhohMmUJc_aQScQGqeLMN8mmsxRFmo",
 authDomain:"liagroup-a1ab1.firebaseapp.com",
 projectId:"liagroup-a1ab1",
 storageBucket:"liagroup-a1ab1.appspot.com",
 messagingSenderId:"361842389207",
 appId:"1:361842389207:web:1a7b92ef9d85b2726a4092"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

/* èªè¨¼ */
onAuthStateChanged(auth,user=>{
 if(!user){location.href="index.html";return;}
 document.getElementById("staff").value=user.email;
 generateCase();
});

/* æ¡ˆä»¶ç•ªå·ç”Ÿæˆ */
async function generateCase(){
 const today=new Date();
 const key=today.toISOString().slice(0,10).replaceAll("-","");
 const snap=await getDocs(query(collection(db,"sales"),where("dateKey","==",key)));
 document.getElementById("caseNumber").value=`${key}-${snap.size+1}`;
}

/* è¡Œè¿½åŠ  */
window.addRow=()=>{
 const tr=document.createElement("tr");
 tr.innerHTML=`
  <td><input class="item"></td>
  <td><input class="name"></td>
  <td><input type="number" class="price"></td>
  <td><input type="number" class="expect"></td>
  <td><input class="memo"></td>
  <td><button onclick="this.closest('tr').remove()">å‰Šé™¤</button></td>
 `;
 document.querySelector("#buyTable tbody").appendChild(tr);
};
addRow();

/* ä¿å­˜ */
window.saveReport=async()=>{
 const rows=document.querySelectorAll("#buyTable tbody tr");
 if(!rows.length){alert("å…¥åŠ›ãªã—");return;}

 const caseNo=caseNumber.value;
 const storeVal=store.value;
 const staffVal=staff.value;

 const today=new Date();
 const dateKey=today.toISOString().slice(0,10).replaceAll("-","");

 for(const r of rows){
  const item=r.querySelector(".item").value;
  const name=r.querySelector(".name").value;
  const price=Number(r.querySelector(".price").value||0);
  const expect=Number(r.querySelector(".expect").value||0);
  const memo=r.querySelector(".memo").value;

  const doc=await addDoc(collection(db,"sales"),{
   item,name,price,expect,memo,
   caseNumber:caseNo,
   store:storeVal,
   user:staffVal,
   barcode:"INV"+Math.random().toString(36).substring(2,8),
   dateKey,
   createdAt:serverTimestamp()
  });

  /* ğŸ”¥ è‡ªå‹•å‡ºé‡‘ */
  if(price>0){
   await addDoc(collection(db,"expenses"),{
    type:"out",
    item:"è²·å–",
    amount:price,
    note:name,
    caseNumber:caseNo,
    createdAt:serverTimestamp()
   });
  }
 }

 alert("æ—¥å ±ä¿å­˜å®Œäº†");
 generateCase();
 document.querySelector("#buyTable tbody").innerHTML="";
 addRow();
};
</script>
</body>
</html>